/* Noms des coéquipiers
 * NOM, Prénom      :  PHILIBERT,   Christophe
 * NOM, Prénom      :  TELLIER,     Alexandre
 * NOM, Prénom      :  ZHAO,        Jian Chen
 * 
 * Fichier          : main.c
 * Date de création : 17 fév. 2017
 * Microcontrôleur  : PIC16F1619, 32 MHz
 * Description      :
 */

#include "config.h"     // fusibles de configuration
#include "bsp.h"        // pour la plaquette démo Curiosity
#include "ultrason.h"  
#include <stdint.h>



// *** Définitions d'étiquettes (macros) ***

#define DELAI_50MSEC    10
#define DELAI_10MSEC    2

#define TMR3H_INIT      99
#define TMR3L_INIT      192



// *** Variables globales ***


// *** Prototypes ***
void init(void);

// *** Point d'entrée du programme ***
void main() {
    init();
    
    for(;;)
    {
        ultrason();
    }
}

// *** Routine d'interruption matérielle ***
void interrupt ISR() {
    
    static char etape = 0;
    static char pulse = 0;
    static char att_ult = 0;
    
    if(IOCIF)                           //interruption sur la broche RC3
    {
        if(!etape)                      //comencement de la prise du temps du pulse
        {
            TMR5ON = 1;
            etape++;
        }
        else if(etape)                  //fin de la prise du temps
        {
            TMR5ON = 0;
            mesure_ultrason_done = 1;   //annonce le début de l'analyse dans le main()-> Ultrason
            etape = 0;
        }
        
        IOCIF = 0;                      
        IOCCF3 = 0;
    }
    if(TMR3IF)                                                                  
    {
        if(attente_pulse && (++pulse == DELAI_10MSEC))       // attente de 10ms pour le pulse en début d'analyse de distance                   
        {
            TRIG = 0;                                                           
            lancer_mesure_ultrason = 1;                                         
            attente_pulse = 0;                                                  
            pulse = 0;                                                          
        }
        if(attente_ultrason && (++att_ult == DELAI_50MSEC))  //attente obligatoire pour le bon fonctionnement du capteur              
        {
            lancer_mesure_ultrason = 1;                                         
            attente_ultrason = 0;                                               
            att_ult = 0;                                                        
        }
        
        TMR3IF = 0;                                                             
        TMR3H = TMR3H_INIT;                                                     
        TMR3L = TMR3L_INIT;                                                     
    }
   
    
}

// *** Initialisations générales ***
void init() {
    OSCCON = 0b11110000;
    bsp_init(); 
    
    init_ultrason();
    
    T3CON = 0b00000001;
    TMR3IE = 1;
    
    TMR3H = TMR3H_INIT;
    TMR3L = TMR3L_INIT;
    
    INTCON = 0b11001000;        //PEIE + GIE + interruption sur les broches
    
}

// *** Autres fonctions ***